apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-backup
  namespace: toptal
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM UTC
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: default
          containers:
            - name: backup
              image: amazon/aws-cli:latest
              command:
                - /bin/sh
                - -c
                - |
                  DATE=$(date +%Y%m%d-%H%M%S)
                  SNAPSHOT_ID="toptal-backup-${DATE}"
                  echo "Creating RDS snapshot: ${SNAPSHOT_ID}"
                  aws rds create-db-snapshot \
                    --db-instance-identifier toptal-3tier-db \
                    --db-snapshot-identifier ${SNAPSHOT_ID} \
                    --region us-east-1
                  echo "Snapshot initiated: ${SNAPSHOT_ID}"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
          restartPolicy: OnFailure
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3